{"version":3,"sources":["../../../../src/modules/cache/methods/get.js"],"names":["debug","require","ERROR_INFO","module","action","plugin","request","key","setCb","tags","join","Promise","reject","property","undefined","Array","isArray","client","hgetall","then","__success","catch","err","log","error","res","callSetIfCallbackExists","act","JSON","parse","value","parseReviver","app","resolve","promise","search","Date"],"mappings":"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","file":"get.js","sourcesContent":["const debug = require('debug')('microjs:plugins:redis:cache:get');\nimport isString from 'lodash.isstring';\nimport isFunction from 'lodash.isfunction';\nimport { MODULE_NAME, ACTION_NAME_GET } from '../constants';\nimport { PIN_CACHE_SET } from '../pins';\nimport { PIN_TAGS_HAS } from '../../pins';\nimport internalError from '../../../errors/internal-error';\nimport propertyIsRequiredError from '../../../errors/property-is-required-error';\nimport tagsMustBeFunctionOrUndefinedError from './../errors/setCb-must-be-function-or-undefined';\nimport tagsMustBeArrayOrUndefinedError from './../errors/tags-must-be-array-or-undefined';\n\nconst ERROR_INFO = { module: MODULE_NAME, action: ACTION_NAME_GET };\n\n/**\n * Получает значение ключа из кеша\n * - если передан метод setCb вызовет получение нового значения ключа если такового нет\n *\n * @param {object} plugin         Экземпляр плагина\n * @returns {function({key?: *, setCb?: *, tags?: *}): Promise}\n */\nexport default (plugin) => (request) => {\n  const { key, setCb, tags } = request;\n  debug('Вызван метод: \"cache.get\" с параметрами: %O', { key, setCb, tags });\n  \n  debug(`Проверка свойства \"key\": !isString(key) || key === ''|| key === '*'`);\n  if (!isString(key) || key === ''|| key === '*') {\n    debug([\n      '[error] Результаты:',\n      `$1 => ${ !isString(key) }`,\n      `$2 => ${ key === '' }`,\n      `$3 => ${ key === '*' }`\n    ].join('\\n'));\n    return Promise.reject(propertyIsRequiredError({ ...ERROR_INFO, property: 'key' }));\n  }\n  \n  debug(`Проверка свойства \"setCb\": !isFunction(setCb) && setCb !== undefined`);\n  if (!isFunction(setCb) && setCb !== undefined) {\n    debug([\n      '[error] Результаты:',\n      `$1 => ${ !isFunction(setCb) }`,\n      `$2 => ${ setCb !== undefined }`,\n    ].join('\\n'));\n    return Promise.reject(tagsMustBeFunctionOrUndefinedError(ERROR_INFO));\n  }\n  \n  debug(`Проверка свойства \"tags\": !Array.isArray(tags) && tags !== undefined`);\n  if (!Array.isArray(tags) && tags !== undefined) {\n    debug([\n      '[error] Результаты:'\n      `$1 => ${ !Array.isArray(tags) }`,\n      `$2 => ${ tags !== undefined }`,\n    ].join('\\n'));\n    return Promise.reject(tagsMustBeArrayOrUndefinedError(ERROR_INFO));\n  }\n  \n  return plugin.client.hgetall(key)\n    .then(__success)\n    .catch(err => {\n      debug(`Поймали ошибку вызова метода \"hgetall\": `, err);\n      request.log.error(err);\n      throw internalError(request, err, ERROR_INFO);\n    });\n  \n  function __success(res) {\n    if (res === null) {\n      debug(`Запрашиваемый ключ \"%s\" отсутвует: %s === null`, key, res);\n      return callSetIfCallbackExists(request, { key, setCb, tags });\n    }\n    \n    debug(`Проверим актуальность тегов`);\n    return request.act({ ...PIN_TAGS_HAS, tags: JSON.parse(res.tags) })\n      .then(\n        () => {\n          debug(`Теги актуальны - парсим и возвращаем результат`);\n          return JSON.parse(res.value, parseReviver);\n        },\n        () => {\n          debug(`Теги не актуальны`);\n          return callSetIfCallbackExists(request, { key, setCb, tags });\n        }\n      );\n  }\n};\n\n/**\n * Вызывает функцию setCb если он был передан для установки нового значения ключа в кеше\n *\n * @param {app} app               Экземпляр библиотеки MicroJS\n * @param {string} key            Ключ кеша\n * @param {function} [setCb]      Функция получения нового значения\n * @param {Array<string>} [tags]  Список тегов для установки нового значения\n *\n * @returns {Promise<null|*>}     Вернет новое значение для ключа\n */\nfunction callSetIfCallbackExists(app, { key, setCb, tags }) {\n  debug('Начинаем выполнение проверки на обновление по setCb');\n  return new Promise((resolve, reject) => {\n    \n    if (!!setCb) {\n      debug('Вызываем получение результата \"setCb\"');\n      let promise = setCb(key);\n    \n      if (!promise || !('then' in promise && isFunction(promise.then))) {\n        debug('Результат не Promise - обернем его в Promise');\n        promise = Promise.resolve(promise);\n      }\n    \n      return promise\n        .then(value => {\n          debug('Результат \"setCb\" получен, ' +\n            'вызываем установку нового значения для ключа \"%s\": %O',\n            key, { ...PIN_CACHE_SET, key, value, tags }\n          );\n          return app\n            .act({ ...PIN_CACHE_SET, key, value, tags })\n            .then(() => {\n              debug('Новое значение ключа \"%s\" утсановлено, возвращаем его', key);\n              return value;\n            })\n            .catch(error => {\n              debug('[error] Установка нового значения ключа \"%s\" вернуло ошибку: %O', key, error);\n              throw error;\n            });\n        })\n        .then(resolve)\n        .catch(error => {\n          debug('[error] Вызов метода \"setCb\" вернул ошибку: %O', error);\n          reject(error);\n        });\n    }\n    \n    debug('Метод \"setCb\" не передан, вернем null');\n    return resolve(null);\n  });\n}\n\n/**\n * Функция вызывается для каждой пары ключ / значение при JSON.parse\n * - нужны чтобы корректно распарсить и восстановить дату в виде объекта Date\n *\n * @param {string} key\n * @param {*} value\n * @returns {*}\n */\nfunction parseReviver(key, value) {\n  if (!!value && !!value.search && !!~value.search(/^[0-9]{4}[-]{1}[0-9]{2}[-]{1}[0-9]{2}[A-Z]{1}[0-9]{2}[:]{1}[0-9]{2}[:]{1}[0-9]{2}[\\.]{1}[0-9]{3}[A-Z]{1}$/)) {\n    return new Date(value);\n  }\n  return value;\n}"]}